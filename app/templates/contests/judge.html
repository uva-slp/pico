{% extends 'contests/base.html' %}

{% load bootstrap3 %}
{% load contest_extras %}

{% block title_block %}{{ contest_data.title }} Contest{% endblock %}

{% block head_block %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/diff.css' %}" />
    {{ block.super }}
{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url 'contests:contest' contest_id=contest_data.id %}">{{ contest_data.title }}</a></li>
    <li><a href="{% url 'contests:contest_submissions' contest_id=contest_data.id %}">Submissions</a></li>
    <li class="active">Judge</li>
{% endblock %}

{% block content_block %}
    <h1>Contest: {{ contest_data.title }}</h1>
    <h2>Judging submission:</h2>
    <br />

    <!-- TODO: update when contest support multiple judges-->
    {% if request.user == contest_data.creator %}
    <div class="panel panel-default panel-table">
        <div class="panel-heading">
            <div class="row">
                <div class="col col-xs-4">
                    <h3 class="panel-title">Run ID: {{ submission.run_id }}</h3>
                </div>
                <div class="col col-xs-4">
                    <h3 class="panel-title">Team: {{ submission.team.name }} </h3>
                </div>
                <div class="col col-xs-4">
                    <h3 class="panel-title">State: {{ submission.get_state_display }}</h3>
                </div>
            </div>
        </div>
        <div class="panel-body">
	<div>
		<div>
			<button id="first">first</button>
			<button id="prev">prev</button>
			<button id="next">next</button>
			<button id="last">last</button>
		</div>
		{{ diff_table|safe }}
	</div>
	<script type="text/javascript">

		////////////////////////
		// Diff table nav bar //
		////////////////////////

		var numChanges = {{ numChanges }};
		
		var cur = 0;
		var url = document.location.toString()
		var i = url.indexOf("#");
		if (i != -1) {
			cur = parseInt(url.substring(i+1));
		}
		if (cur > numChanges || Number.isNaN(cur)) {
			cur = 0;
			document.location = url.substring(0,i);
		}

		var first = 0;
		var prev = cur-1;
		var next = cur+1;
		var last = numChanges-1;

		function goToAnchor(anchor) {
			var loc = document.location.toString().split('#')[0];
			document.location = loc + '#' + anchor;

			cur = anchor;
			prev = anchor-1;
			next = anchor+1;

			$('#first').prop('disabled', numChanges==0||cur==first);
			$('#last').prop('disabled', numChanges==0||cur==last);
			$('#prev').prop('disabled', prev<0);
			$('#next').prop('disabled', next>last);
		}

		$('document').ready(function(){
			$('#first').click(function(){
				goToAnchor(first);
			});
			$('#last').click(function(){
				goToAnchor(last);
			});
			$('#prev').click(function(){
				goToAnchor(prev);
			});
			$('#next').click(function(){
				goToAnchor(next);
			});

			$('#first').prop('disabled', numChanges==0||cur==first);
			$('#last').prop('disabled', numChanges==0||cur==last);
			$('#prev').prop('disabled', prev<0);
			$('#next').prop('disabled', next>last);
		});

		////////////////////////
		// Diff table display //
		////////////////////////

		var $table = $('table.diff-table');
		var $theadCells = $table.find('thead tr').children();

		$(window).resize(function() {
	    	var tableWidth = $table.find('tbody').width();
	    	$theadCells.each(function(i, th) {
	    		$(th).width(tableWidth/2);
	    	});
		}).resize();

	</script>
        </div>
        <div class="panel-footer">
            <form class="form-inline" enctype="multipart/form-data" action="{% url 'contests:contest_judge' contest_data.id submission.run_id%}" method="post">
                {% csrf_token %}
                {{ form }}
            <input class="pull-right" type="submit" value="Submit"/>
            </form>
        </div>
    </div>
    {% endif %}
{% endblock %}
