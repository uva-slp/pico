{% extends 'contests/base.html' %}

{% load bootstrap3 %}
{% load staticfiles %}
{% load contest_extras %}

{% block title_block %}{{ block.super }}{% endblock %}

{% block head_block %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/diff.css' %}" />
    {{ block.super }}
{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url 'contests:contest' contest_id=contest_data.id %}">{{ contest_data.title }}</a></li>
    <li><a href="{% url 'contests:contest_judge_submissions' contest_id=contest_data.id %}">Submissions</a></li>
    <li class="active">Judge</li>
{% endblock %}

{% block content_block %}
    {{ block.super }}

    <h2>Judging submission:</h2>
    <br />

    {% if is_judge %}
    <div class="panel panel-default panel-table">
        <div class="panel-heading">
            <div class="row">
                <div class="col col-xs-4">
                    <h3 class="panel-title">Run ID: {{ submission.run_id }}</h3>
                </div>
                <div class="col col-xs-4">
                    <h3 class="panel-title">Team: {{ submission.team.name }} </h3>
                </div>
                <div class="col col-xs-4">
                    <h3 class="panel-title">State: {{ submission.get_state_display }}</h3>
                </div>
            </div>
        </div>
        <div class="panel-body">
	<div>
		<div>
			<button id="first" class="btn btn-default">first</button>
			<button id="prev" class="btn btn-default">prev</button>
			<button id="next" class="btn btn-default">next</button>
			<button id="last" class="btn btn-default">last</button>

            <span class="checkbox" style="display:inline-block;margin-left:20px;">
                <label><input id="checkbox-whitespace" type="checkbox" checked>Whitespace</label>
            </span>
            <span class="checkbox" style="display:inline-block;margin-left:20px;">
                <label><input id="checkbox-emptylines" type="checkbox" checked>Empty lines</label>
            </span>

            <span style="display:inline-block;margin-left:20px;">
                <label>Differences:</label> <span id="numChanges">{{numChanges}}</span> lines
            </span>

		</div>
        <br/>
		{{ diff_table|safe }}

    	</div>
            </div>
            <div class="panel-footer">
                <form class="form-inline" enctype="multipart/form-data" action="{% url 'contests:contest_judge' contest_data.id submission.run_id%}" method="post">
                    {% csrf_token %}
                    <label>Result&nbsp;</label>
                    {% bootstrap_form form layout='inline' %}
                    <input class="pull-right btn btn-default" type="submit" value="Submit" name="submit"/>
                </form>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block foot_block %}

    {{ block.super }}

    <script type="text/javascript">

        ////////////////////////
        // Diff table nav bar //
        ////////////////////////

        var numChanges = {{ numChanges }};
        
        var cur = 0;
        var url = document.location.toString()
        var i = url.indexOf("#");
        if (i != -1) {
            cur = parseInt(url.substring(i+1));
        }
        if (cur > numChanges || Number.isNaN(cur)) {
            cur = 0;
            document.location = url.substring(0,i);
        }

        var first = 0;
        var prev = cur-1;
        var next = cur+1;
        var last = numChanges-1;

        function goToAnchor(anchor) {
            var loc = document.location.toString().split('#')[0];
            document.location = loc + '#' + anchor;

            cur = anchor;
            prev = anchor-1;
            next = anchor+1;

            $('#first').prop('disabled', numChanges==0||cur==first);
            $('#last').prop('disabled', numChanges==0||cur==last);
            $('#prev').prop('disabled', prev<0);
            $('#next').prop('disabled', next>last);
        }

        $('document').ready(function(){
            $('#first').click(function(){
                goToAnchor(first);
            });
            $('#last').click(function(){
                goToAnchor(last);
            });
            $('#prev').click(function(){
                goToAnchor(prev);
            });
            $('#next').click(function(){
                goToAnchor(next);
            });

            $('#first').prop('disabled', numChanges==0||cur==first);
            $('#last').prop('disabled', numChanges==0||cur==last);
            $('#prev').prop('disabled', prev<0);
            $('#next').prop('disabled', next>last);
        });

        ///////////////////////
        // Intelligent diffs //
        ///////////////////////

        function resetDiffBackgrounds() {
            $('.diff-text:not(:has(.diff-add:not(.diff-none),.diff-del:not(.diff-none),.diff-chg:not(.diff-none)))').addClass('diff-none');
            $('.diff-text:has(.diff-add:not(.diff-none),.diff-del:not(.diff-none),.diff-chg:not(.diff-none))').removeClass('diff-none');
        };

        function syncNumChanges() {
            var numChanges = $('.diff-table tr:has(.diff-text:has(.diff-add:not(.diff-none),.diff-del:not(.diff-none),.diff-chg:not(.diff-none)))').length;
            $('#numChanges').text(numChanges);
            return numChanges;
        };

        $('#checkbox-whitespace').change(function() {
            if (this.checked) {
                $('.diff-whitespace').removeClass('diff-none').closest('.diff-text').removeClass('diff-none');
            } else {
                $('.diff-whitespace').addClass('diff-none');
                resetDiffBackgrounds();
            }
            syncNumChanges();
        });
        $('#checkbox-emptylines').change(function() {
            if (this.checked) {
                $('.diff-emptyline').removeClass('diff-none').closest('.diff-text').removeClass('diff-none');
            } else {
                $('.diff-emptyline').addClass('diff-none');
                resetDiffBackgrounds();
            }
            syncNumChanges();
        });
        syncNumChanges();

    </script>
{% endblock %}
