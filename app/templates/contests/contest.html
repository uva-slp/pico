{% extends 'contests/base.html' %}

{% load bootstrap3 %}
{% load staticfiles %}
{% load contest_extras %}

{% block title_block %}{{ contest_data.title }}{% endblock %}

{% block head_block %}
    {{ block.super }}

    <link rel="stylesheet" href="{% static 'css/timer_bar.css' %}">
{% endblock %}

{% block breadcrumb %}
    <li class="active">{{ contest_data.title }}</li>
{% endblock %}

{% block content_block %}
    {{ block.super }}

    <!-- Time Remaining Bar -->
    {% if contest_data.contest_start != NULL and not is_past %}
        <div class="progress slower" id="timer_bar">
            <div class="time_remaining_div"><span class="time_remaining_text"></span></div>
            <div id="progress-slow" class="progress-bar progress-bar-striped active live_timer_div" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="height:170px; width:100%"></div>
        </div>
    {% endif %}

    {% if is_past %}
        <div class="well bs-component" style="text-align:center;">
            <h3>This is a past contest for viewing purposes only</h3>
            <p>(No new submissions or changes can be made)</p>
        </div>
    {% endif %}

    <div class="row text-center">
        <h1 style="font-weight: bold;">{{ contest_data.title }}</h1>
    </div>
    <br />

    {% if is_judge or is_creator %}
        <div class="well bs-component">
            <span style="font-weight: bold;; float:left;">Judge Panel:</span>
            <div class="col-lg-8 col-lg-offset-2">
                <a class="btn-toolbar center-block">
                    <a href="{% url 'contests:contest_judge_submissions' contest_data.id %}" class="btn btn-default">View all submissions</a>
                </a>
                <span style="margin: 40px;"></span>
                <a class="btn-toolbar" style="float:right;">
                    {% if contest_data.contest_start == NULL %}
                        <a href="{% url 'contests:activate_contest' contest_data.id %}" class="btn btn-success">Activate Contest</a>
                    {% endif %}
                    {% if not is_past %}
                        <a href="{% url 'contests:edit_contest' contest_data.id %}" class="btn btn-primary">Edit Contest</a>
                    {% endif %}
                        <a href="{% url 'contests:delete_contest' contest_data.id %}" onclick="return confirm('Delete this contest?')" class="btn btn-danger">Delete Contest</a>
                </a>
            </div>
            <br />
        </div>
    {% endif %}

    {% if contest_data.contest_start != NULL or is_judge or is_creator %}
    <br />
        <a href="{% url 'contests:scoreboard' contest_data.id %}" class="btn btn-default">View Scoreboard</a>
    <br /><br />

    {% if current_team is not None %}
        <br /><a href="{% url 'contests:contest_submissions' contest_data.id current_team.id %}" class="btn btn-default">View my submissions</a><br />
    {% endif %}

    <br />
        <a href="{% url 'contests:problem_description' contest_data.id %}" class="btn btn-default">Problem Descriptions</a>
    <br /><br />

    <h3>Contest Problems:</h3>
    <div class="panel-group" id="accordion">
    {% for pair in problem_form_pairs %}
            {% if not is_participant %}
                <div class="panel panel-default">
            {% else %}
                <div class="panel panel-{{ color_states|index:forloop.counter }}">
            {% endif %}
                <!-- the data-parent attribute make sure only one panel is open at a time-->
                <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" data-target="#collapse{{ forloop.counter }}">
                    <h4 class="panel-title">
                        <div style="display: table; width: 100%;">
                            <div class="col-sm-4" style="display: table-cell;">
                                Problem {{ forloop.counter }}
                            </div>
                            {% if is_participant %}
                            <div class="col-sm-4" style="display: table-cell;">
                                Submission Attempts: {{ submission_attempts|index:forloop.counter }}
                            </div>
                            <div class="col-sm-4" style="display: table-cell;">
                                Status: {{ submission_status|index:forloop.counter }}
                            </div>
                            {% endif %}
                        </div>
                    </h4>
                </div>
                <div id="collapse{{ forloop.counter }}" class="panel-collapse collapse">
                    <ul class="list-group">
                        <li class="list-group-item">Description of Input
                            <div class="panel-body">
                                {{ pair.0.input_description }}
                            </div>
                        </li>
                        <li class="list-group-item">Description of Output
                            <div class="panel-body">
                                {{ pair.0.output_description }}
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div style="display: table; width: 100%;">
                                <div class="col-sm-6" style="display: table-cell;">Sample Input
                                    <div class="panel-body">
                                         <pre>{{ pair.0.sample_input|print_file_content }}</pre>
                                    </div>
                                </div>
                                <div class="col-sm-6" style="display: table-cell;">Sample Output
                                    <div class="panel-body">
                                         <pre>{{ pair.0.sample_output|print_file_content }}</pre>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="panel-footer">
		      <form enctype="multipart/form-data" action="{% url 'contests:contest' contest_data.id %}" method="post">
			{% csrf_token %}
			Upload your file:
			{{ pair.1.as_p }}
			<input type="submit" value="Submit"/>
		      </form>
		    </div>
                </div>
            </div>
    {% endfor %}
    </div>
    {% else %}
        <div class="well bs-component" style="text-align:center;">
            <h3>This contest has not begun yet</h3>
            <br />
            <a href="{% url 'contests:index' %}" class="btn btn-primary">Return Home</a>
        </div>
    {% endif %}
{% endblock %}

{% block foot_block %}
    {{ block.super }}

    {% if contest_data.contest_start != NULL or is_judge or is_creator %}
        <script type="text/javascript" src="{% static 'moment/moment.min.js' %}"></script>

        <!-- Set global js vars with django data for external scripts to use -->
        <script type="text/javascript">
            var CountDown = (function() {
                // Update contest time remaining bar
                var contest_start = '{{ contest_data.contest_start }}';
                var contest_length = '{{ contest_data.contest_length }}';
                var is_contest_started = contest_start != "None";
                var home_url = "{% url 'contests:index' %}";
                var is_contest_ended = false;

                var hours = Number(contest_length.substring(0, 2));

                if(contest_length.includes("a.m.")) {
                    if(hours == 12) {
                        contest_length = '00' + contest_length.substring(2);
                    }
                } else {
                    if(hours != 12) {
                        hours += 12;
                        contest_length = '' + hours + contest_length.substring(2);
                    }
                }
                console.log("start: " + contest_start + ", length: " + contest_length);

                //var len_test = new Date("2000-01-01 " + contest_length);
                //console.log("length: " + len_test);

                var secondFraction = '5'; // determines progress-bar animation speed
                $('#progress-slow').css('animation', secondFraction + 's linear 0s normal none infinite progress-bar-stripes');

                var start_time = moment(contest_start, 'MMM DD, YYYY, hh:mm:ss a');
                var length_time = moment(contest_length, 'HH:mm');
                var length = length_time.hour() * 3600 + length_time.minute() * 60;
                var end_time = moment(start_time).add(length_time.hour(), 'hours').add(length_time.minute());

                var warning_time = moment(start_time).add(length * 0.90, 'seconds'); // 10% of contest length left
                var danger_time = moment(start_time).add(length * 0.75, 'seconds'); // 25% of contest length left
                var last_minute_time = moment(end_time).subtract(1, 'minutes');
                var viewable_time = moment(end_time).add(1, 'minutes');

                var percentage_increment = 100 / length; // the amount to increase the percentage bar per minute
                var progress_bar_percentage;

                var live_timer_div = $(".live_timer_div");
                var time_remaining_text = $(".time_remaining_text");

                var update = function() {

                    function updateDuration(curr_time) {
                        console.log("start: " + contest_start + ", length: " + length_time);
                        curr_time = moment(curr_time, 'YYYY/MM/DD HH:mm:ss');
                        var time_remaining = moment.duration(moment(end_time).diff(curr_time)).asSeconds();

                        if(curr_time.isBefore(end_time)) {
                            var hours_remaining = ('0' + Math.floor(time_remaining / 3600)).slice(-2);
                            var minutes_remaining = ('0' + Math.floor((time_remaining % 3600) / 60)).slice(-2);
                            var seconds_remaining = ('0' + (time_remaining % 60).toFixed()).slice(-2);

                            time_remaining_text.html(hours_remaining + 'h : ' + minutes_remaining + 'm : ' + seconds_remaining + 's remaining');
                            /*var hour_string = hours_remaining == 1 ? 'hour' : 'hours';
                             var minute_string = minutes_remaining == 1 ? 'minute' : 'minutes';
                             if(hours_remaining >= 1) {
                             time_remaining_text.html(hours_remaining + ' ' + hour_string + ' ' + minutes_remaining + ' ' + minute_string + ' remaining');
                             } else if(minutes_remaining >= 1) {
                             time_remaining_text.html(minutes_remaining + ' ' + minute_string + ' remaining');
                             } else {
                             time_remaining_text.html(seconds_remaining + ' seconds remaining');
                             }*/

                            progress_bar_percentage = time_remaining * percentage_increment;
                            live_timer_div.css("width", progress_bar_percentage + "%");

                            if (curr_time.isAfter(warning_time)) { // 10% of contest length left
                                live_timer_div.removeClass("progress-bar-success progress-bar-warning");
                                live_timer_div.addClass("progress-bar-danger");
                            } else if (curr_time.isAfter(danger_time)) { // 25% of contest length left
                                live_timer_div.removeClass("progress-bar-success progress-bar-danger");
                                live_timer_div.addClass("progress-bar-warning");
                            }

                            if(curr_time.isSame(last_minute_time)) {
                                window.alert("You have 1 minute remaining.");
                            }
                        } else {
                            // contest is over, past contest may be viewed 1 minute after ending
                            is_contest_ended = true;
                            if(curr_time.isBefore(viewable_time)) {
                                window.alert("The contest is now over! You may view it 1 minute after it has ended.");
                                window.location.replace(home_url);
                            } else {
                                // any additional 'view past contest' logic
                            }
                        }
                    }

                    updateDuration(moment());
                };

                $(document).ready(function() {
                    if(is_contest_started && !is_contest_ended) { // keep refreshing contest if active contest
                        update();
                        setInterval(update, 1000);
                    }

                    if(!is_contest_started || is_contest_ended) { // disallow code submission if unstarted or past contest
                        $("#id_code_file").prop('disabled', true);
                        $("input[type='submit']").prop('disabled', true);
                    }
                });
            })();
        </script>

        <script type="text/javascript" src="{% static 'js/lock_navbar.js' %}"></script>
        <script src="{% static 'js/refresh_scoreboard.js' %}"></script>

        <script type="text/javascript">
            var cd = new CountDown();
        </script>
    {% endif %}
{% endblock %}